# オンラインリソースによる考古遺跡地図作成

#### *FOSS4G Japan 2020 Online チュートリアルデイ*  

2020年11月7日　10:00～12:00（予定）

### 事前準備
#### Zoomミーティング
- 本チュートリアルはZoomを使用します。予めZoomアプリをインストールしてください  
    - 旧バージョンのZoomはセキュリティの関係などで正常に作動しない場合があります。必ず最新バージョンにアップデートしてください  
    - 参加用のリンクURLはFOSS4Gを通じてご案内しています

- ~Zoomミーティングへの参加~
1. ~「待機室」が有効になっています。お名前を確認した上で参加を承認します~

2. ビデオのオンオフ(顔出し)は任意です。マイクは基本オフ(ミュート)で開始してください

3. 進行中の確認当はZoomのリアクション(非言語的フィードバック)を使用します
    - 実習の作業が完了した場合は緑色のチェック✅をクリックしてください  
    - 質問等がある場合は挙手✋をクリックしてください  
    - 質問内容はチャットに書き込んでください  
    - 参考：ミーティング中の非言語的フィードバック  

4. ~オンラインワークショップでは、互いに面識のない方が多数参加します。お互いを尊重し、ハラスメント行為などは決して行わないようにしてください~  
    - ~直接の知り合いでない場合、個別の連絡(チャット等)を一方的に行なったり返信を要求すること、連絡先を求めることは行なわないでください~  
    - ~スクリーンショット撮影を行なう場合、写り込んだ他の参加者の肖像権・プライバシーを尊重してください（講師についてはその限りではありません）~  

#### GitHubリポジトリ
- チュートリアルで使用するデータ、スライドはGitHubリポジトリで公開しています  

- スライド: https://kotdijian.github.io/JASOSR//FOSS4Gtutorial **(未完)**  
- リポジトリ上のリソース1: https://github.com/kotdijian/JASOSR/tree/master/FOSS4Gtutorial  
    - README.md: 本ドキュメントです  
    - slide.md: オンライン・チュートリアルのスライドです  
    - sample01.csv: 実習2で使用する.csvデータです。東京都遺跡地図から取得した小金井市の遺跡一覧リストです(UTF-8、BOMなし)  
    - sample02.csv: 実習4で使用する.csvデータです。東京都遺跡地図から取得した全遺跡一覧リストに位置座標を追加したものです(UTF-8、BOMなし)  
    - sample03.csv: sample02.csvから23区の遺跡データを抽出したものです(UTF-8、BOMなし)  

- リポジトリ上のリソース2: https://github.com/kotdijian/JASOSR/tree/master/13Tokyo  
    - 東京都遺跡地図にもとづくデータセットです  
    - 「ひなたGIS」を利用した地図作成実習（後述）ではSJSサブフォルダ内のShift-JISファイルを使用します  
    - 詳細は当該フォルダ内のREADME.mdを参照ください  

#### データ収集・編集加工  
- チュートリアルではGoogleスプレッドシートを使用します  
- 同じ手順での実習を希望する方は、各自のGoogleアカウントでマイドライブ上にスプレッドシートを作成してください  
- Microsoft Excel(オンライン、デスクトップ・アプリ)等の表計算ソフトでも実行できますが、メニュー、コマンド、一部の操作が異なります。予めご了承ください  
- データのエンコードを変更するためにテキストエディタを使用します。Windowsユーザーはメモ帳を利用できます。Macユーザーは予めShif-JISを利用できるエディタを用意しておいてください  

***

### 実習1：東京都遺跡地図データの取得  

1. [東京都遺跡地図情報インターネット提供サービス](https://tokyo-iseki.metro.tokyo.lg.jp/)を開きます  
2. 利用条件に同意して地図画面に移ります  
3. 遺跡名、所在地（区市町村）、時代などを選択します  
4. 地図画面下のリストor地図画面上の表示から遺跡を選択します  
5. 詳細をクリックして情報を表示します  
6. 表示された情報をコピーします  
7. コピーした情報をスプレッドシートに貼りつけます  
8. データの配列が縦方向（見出し・項目が列、属性情報が行に配置されている）なので、横方向（見出しが先頭行・項目が各行、属性情報が列）に変換します  
    * スプレッドシートの場合: 範囲を選択→右クリック→「特殊貼り付け」→「転置して貼り付けする」  
    * Microsoft Excelの場合: 「ホーム」→「貼り付け」→「行／列の入れ替え」  
9. 2件目以降は項目部分（コピーしたデータの右列）のみを選択して「転置して貼り付けする」  
10. 作成したリストを.csv形式で保存します  
    * スプレッドシートの場合:「ファイル」→「ダウンロード」→「カンマ区切りの値(.csv)」→フォルダとファイル名の指定  
    * Microsoft Excelの場合:「ファイル」→「名前を付けて保存」→フォルダとファイル名の指定→ファイル形式として「CSV(コンマ区切り)」を指定  

**注意事項1** 東京都遺跡地図のデータに含まれるもの  
* Unicode(UTF-8)と互換性のない文字が含まれています("No." U+2116，ローマ数字，その他記号，一部の漢字)。エンコードの変換の際に文字化けします  
* /,[],()などの[正規表現](https://ja.wikipedia.org/wiki/%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE)に使用される記号はプログラム処理の際に影響します  

**注意事項2** 東京都遺跡地図のデータには含まれないもの  
* セル内に改行記号が含まれているとテキストデータ書き出しの際にスプレッドシート上で見かけ上1行のレコードが分割され不整なデータとなります  
* セル内の文字列にカンマが含まれているとテキストデータ書き出しの際に列数が増え不整なデータとなります  
* セルの結合を行なうとテキストデータ書き出しの際に列数が減り不整なデータとなります  

***

### 実習2：ひなたGISによる位置座標の取得

1. sample01.csvをテキストエディタで開き、「所在地」の列名を「変換元住所」に変更します  
2. 保存したファイルをメモ帳などテキストエディタで開きます  
3. 文字コードをShift-JIS（Windowsメモ帳ならANSI）に指定して保存します  
4. ひなたGIS（https://hgis.pref.miyazaki.lg.jp/hinata/）を開きます  
5. 地図画面に遷移し保存した.csvファイルをドロップします  
6. 元データ（ここでは東京都遺跡地図）を参照して正しい位置にプロットします  
7. 任意の場所を右クリック→表示されるメニューの「ファイル」→「csvを保存」  

**Mac-OSユーザー向け** プラグイン不要でShift-JIS変換できるテキストエディタとして以下のものがあるようです  
  - [CotEditor](https://coteditor.com/)  
  - [mi](https://www.mimikaki.net/)
  - [MacVim](https://github.com/splhack/macvim-kaoriya)  

**推奨** UTF-8↔Shift-JISの変換の際の文字化けを回避するため取得した座標データのみを取り出し元のシートに追加でペーストする方が間違いが少ないです  

***

### 実習3：位置情報のないデータの作成等  

1. ひなたGISの画面上で任意の場所を右クリック→「選択してください」→「点」→位置座標を取得したい位置をクリックします 
2. 遺跡番号、遺跡名等の属性情報を追加する場合は赤色の「属性」ボタンをクリックして、必要項目を入力します  
3. 点データは実習2と同じ方法で.csvに書き出し可能です  
4. 線、面（多角形）を描画することも可能。ただし線や面は[GeoJSON形式](https://ja.wikipedia.org/wiki/GeoJSON)で書き出し保存することになります  
5. 作成した点、線、面データは、背景地図の設定と合わせてサーバーに保存しURLとして共有することも可能です。任意の点等を右クリック→ファイル→サーバー保存を選択、保存完了のメッセージが出たらURLをコピー取得します

***

### 実習4：時代別分布図の作成  

1. sample02.csvを開きます  
    * **データが重く動作が遅い／停止する場合は、データ量を減じたsample03.csvを使用してください  
    * **注意事項**: Microsoft Excelの場合、sample02.csv(or 03.csv)をダイレクトに開くと文字化けします(エンコード=UTF-8のため)→「データ」→「テキストまたはCSVから」→フォルダとファイルを指定→「元のファイル」でエンコードを指定(65001: Unicode(UTF-8))→「読み込み」
2. 【時代】の列でフィルターを設定します  
    * スプレッドシートの場合:【時代】列を選択→フィルターボタンをクリック→1行目の列名の横に表示される▼をクリック（フィルターを起動）→「条件でフィルター」→「次を含むテキスト」を選択→「値または数式」に時代を入力します  
    * Microsoft Excelの場合:「ホーム」→「並べ替えとフィルター」→「フィルター」→列名【時代】の横に表示される▼をクリック（フィルターを起動）→「テキストフィルター」→「指定の値を含む」→「オートフィルター オプション」の「抽出条件の指定：時代」に次代を入力します  
    * 東京都遺跡地図の時代区分は、旧石器、縄文、弥生、古墳、奈良、平安、中世、近世と不明の9項目  
    * 種別、主な遺構、主な出土品でフィルターをかけることで異なる分布図を作成できます  
    * フィルターを重ねることも可能　例) 縄文時代の貝塚、中世の出土品に「銭」を含む遺跡etc.  
3. フィルターされた一覧表の全体をコピー→新しいシートに貼り付けます  
4. 新しいシートを.csvで書き出し保存します。必要に応じてUTF-8→Shift-JISに変換します。手順は実習2と同じです  
    * スプレッドシートの場合: .csvファイルはUTF-8で書き出されます。**Shift-JISへの変換が必要です**  
    * Microsoft Excelの場合: .csvファイルはShift-JISで書き出されます。**ひなたGISへはそのまま読み込めます**  
5. Shift-JISに変換した.csvファイルを「ひなたGIS」に読み込み表示させます  

***

### 実習5：背景地図の選択等  
1. 実習4で作成した地図をもとに背景に表示する地図を切り替えます  
2. ひなたGIS画面右上の赤色の「背景」をクリック→表示したい地図等を選択します  
3. 複数の地図を重ね合わせ、前面の地図を透過させることも可能です  
4. 地図上の任意の点を右クリック→「効果」から、ヒートマップやバッファーを表示することも可能です  

***

### 実習6：複数のデータソースを色分けして表示する  
1. 実習4の手順で、異なる条件でフィルターしたデータを2種類以上作成します
* 例1) 中世の城館遺跡と銭貨出土遺跡のリスト  
    * 【時代】=「中世」を含む、【種別】=「城館」を含む  
    * 【時代】=「中世」を含む、【主な出土品】=「銭」を含む  
* 例2) 前方後円墳、方墳、円墳のリスト  
    * 【主な遺構/概要】=「前方後円墳」を含む  
    * 【主な遺構/概要】=「方墳」を含む  
    * 【主な遺構/概要】=「円墳を含む」AND「前方後円墳」を含まない(Microsoft Excelの場合)  
    * スプレッドシートでは論理式を使用できないので「円墳」を含むでリストを作成した後、「前方後円墳」を含まないでさらに絞り込む  
2. 作成したそれぞれのデータの【緯度】列の右に【色】列を追加します  
3. それぞれのデータに異なる色を割り当てます  
    * 色名で指定: blue, red, green, yellow, orange...など  
    * rgbで指定: rgb(0,0,255), rgb(255,0,0), rgb(0,255,0)...など  
4. 各データを順次読み込みます  

* **確認事項**: ひなたGISでは異なるデータをレイヤ分けして保持して表示のON/OFFを切り替えることはできません  
* **発展的確認事項**: スプレッドシート、Microsoft Excelはともに各種関数を使用することでもっと高度な検索・フィルターが可能です。各自で探求してみてください  

***

### 実習7: 地理院地図による分布図の表示  
1. [地理院地図](https://maps.gsi.go.jp/)を開きます  
2. 右上の「ツール」→「作図・ファイル」を選択します  
3. 読み込むデータを地図画面にドロップ、または「作図・ファイル」ウインドウの「ファイルからデータを読み込み」(フォルダのアイコン)からファイルを指定して読み込みます  
4. 位置情報を取得する列を自動検出し確認するよう要求されます。また同じダイアログでアイコンの種類(色・シンボル)と拡大率(大きさ)を指定します  
5. 読み込んだデータは「作図・ファイル」ウインドウにレイヤー表示されます。個別に表示のON/OFFも可能です  
6. 左上の「地図」ボタンをクリックすると「地図の種類」ウインドウが開きます。適宜背景地図を選択してください  

* **重要**: 地理院地図からはcsv形式の書き出し・保存はできません(.kmlまたはGeoJSONのみ)  

***

### 参考: 報告書抄録データの取得  
1. 全国遺跡報告総覧の抄録検索（https://sitereports.nabunken.go.jp/ja/search-site）を開きます  
2. 検索項目の選択・キーワードの入力→該当する書誌・抄録情報を選択します  
3. 抄録データが表示されます。抄録データは以下の3種類の情報が入れ子状になっています  
    * 書誌情報: URL～所収遺跡まで、報告書の冊子単位  
    * 調査地点情報: 遺跡名, 遺跡名かな, 本内順位, 遺跡所在地, 所在地, 市町村コード, 遺跡番号, 緯度経度(日本測地系), 緯度経度(世界測地系), 調査期間, 調査面積, 調査原因, 遺跡概要
    **書誌情報の「所収遺跡」にネストされています**  
    **1冊の報告書に複数の調査地点が含まれている場合があります(1対多対応)** 
    * 遺跡詳細情報: 種別,時代,主な遺構,主な遺物,特記事項
    **調査地点情報の「遺跡概要」にネストされています**
    **(多くの場合)時代別に分けられています**
    **1調査地点に複数の時代別情報が含まれている場合があります(1対多対応)**  
4. **重要** 東京都遺跡地図と異なり位置情報(所在地or緯度経度)と遺跡情報(種別,時代,主な遺構,主な遺物)が分かれて収録されているのでつなげる必要があります  
    1. 調査地点情報をコピーし、転置して貼り付けします。**ただし「遺跡概要」は除きます** (→次の手順で取得するため)  
    2. 遺跡詳細情報をコピーし、転置して貼り付けします  
    3. 同一地点に複数の時代別詳細情報がある場合、調査地点情報をコピーして1行追加し、次の詳細情報をコピー→転置して貼り付けします  
5. **重要** 「全国遺跡報告総覧」の報告書誌情報のリンクを保持するためには、各レコードに【URL】の列を追加し、書誌情報の「URL」をコピーして貼り付けます  

### 参考2：その他の考古学データベース
- 奈良文化財研究所「遺跡データベース」http://mokuren.nabunken.go.jp/Iseki/index.html
- 日本旧石器学会「日本列島の旧石器時代遺跡」http://palaeolithic.jp/data/index.htm
- 国立歴史民俗博物館「縄文・弥生集落データベース」https://www.rekihaku.ac.jp/up-cgi/login.pl?p=param/jomo/db_param
- 奈良文化財研究所「木簡庫」https://mokkanko.nabunken.go.jp/ja/
- 奈良文化財研究所「古代地方官衙関係遺跡データベース」http://mokuren.nabunken.go.jp/NCPstr/NCPstr.htm
- 奈良文化財研究所「古代寺院遺跡データベース」http://mokuren.nabunken.go.jp/NCPstjiin/NCPstrJ.htm
- 国立歴史民俗博物館「東国板碑データベース」https://www.rekihaku.ac.jp/doc/itabi.html
- 国立歴史民俗博物館「陶磁器出土遺跡データベース」https://www.rekihaku.ac.jp/up-cgi/login.pl?p=param/boue/db_param
- 国立歴史民俗博物館「城館城下発掘データベース」https://www.rekihaku.ac.jp/up-cgi/login.pl?p=param/joka/db_param
- 国立歴史民俗博物館「遺跡発掘調査報告書放射性炭素年代測定データベース」https://www.rekihaku.ac.jp/up-cgi/login.pl?p=param/esrd/db_param
- 国立歴史民俗博物館「日本の遺跡出土大型植物遺体データベース」https://www.rekihaku.ac.jp/up-cgi/login.pl?p=param/issi/db_param

### 参考3：文字データのエンコードについて  
- コンピュータで使用される文字の表示方式(エンコード)は、長年、メーカーやOSごとに異なるものが使用されてきました。とくに文字数の多い漢字・ハングルなどや各種記号は不一致が多く、異なるエンコードで互換性がない場合があります  
- 近年、ウェブ上のエンコードの方式はunicode(UTF-8)に統一される傾向にありますが、Windowsを中心にその他の形式が使用されている事例もまだあります  
- 漢字やハングルを含む中国語・日本語・韓国語はエンコードの相違による文字化けが発生しやすく、データの不備やプログラムの実行に支障を来たす場合が多くあります(CJK問題と称される)  
- 考古学においては学史上第2水準漢字の使用がやむを得ないケースがありますが、カタカナ表記を併記するなどの工夫が必要です。ローマ数字や半角カナ、その他の特殊記号は基本的に使用しないことが重要です  

### 参考4：座標数値の表記について
- 緯度・経度の表記については小学校の社会科以降、60進法の度分秒（° ′ ″）で習ってきたと思います。一方、コンピュータのシステムはほぼすべて10進法表記です（内部では2進法→16進法ですが...）  
- ウェブ上の各種地図サービスやGISでは、60進法と10進法の2つの表記に対応している場合もありますが、データは基本的に10進法で取り扱われます
-「度」については従来通り、北緯・南緯0～90度、東経・西経0～180度となります
- 10進法による緯度経度座標の表記では、整数部分は「度」です。60進法による度分秒表記と一致します  
-　小数部分は、「分」「秒」を変換したものとなっています  
    例1) 25分は0.4度です（25/60=0.4）  
    例2) 16秒は0.0044...度です（16/60/60=16/3600=0.0044...）  
    例3) 25分16秒は0.4044...度です  
    - **0.2516または0.25.16とは表記しません**

### 参考5：ズームレベル
- GISやウェブ地図サービスでは、紙地図の縮尺に対応する概念としてズームレベルが定義されています  
ズームレベルは各種ソフトやウェブサービスで共通です
- 参考：https://www.wingfield.gr.jp/archives/5777
- 対象地域の状況（都市か山岳地帯か）や対象物のサイズにより適切なズームレベルを選択しましょう  

### 参考6：位置情報の解像度
- 日本付近では緯度経度1秒の実距離は25～30m四方に相当します  
    - 参考：https://say-no.hatenadiary.org/entry/20110626/1309106165
- 座標数値を秒の単位の整数値とすると上記の幅を含むことになります  

### **重要：測地系について**
- 2002年の測量法改正に伴い、日本における測量・位置計測はITRF座標系GRS80楕円体に準拠すると規定されました。通称「世界測地系」と呼ばれ、GNSS(GPS)測位などで用いられるWGS84座標系とほぼ一致します  
- これにより2002年以降の埋蔵文化財調査等における基準点測量も世界測地系に移行しています。しかしながら2002年以降の成果・刊行物にも、以前の座標系（日本測地系）を採用しているものが散見されます。2002年以前については日本測地系のものがほとんどです  
- 測地系が明記されていない場合、報告書等に記載の緯度経度情報では正しい位置にプロットすることができない場合があります  
- 日本測地系と世界測地系のずれは場所により異なりますが数秒～十数秒になりますので、実距離では200～300m程度のずれが生じることになります  
    - 参考：https://www.drm.jp/jisx0410/JisGridSystem_1_Geoid.html  
- 測地系が不確かな場合は、座標ではなく地図上の位置等を参考に修正する必要がありま　　す
 
### **重要：各種地図データの利用**  
- ひなたGIS、地理院地図で利用可能な地図画像にはそれぞれ利用条件が付されています  
- 利用（刊行・ウェブ公開）にあたっては利用条件を十分に確認し著作権の侵害等がないように必ず確認しましょう　
 
#### 実習の内容・データについて
- 資料・内容はCC-BYで公開します。複製、再利用、転載、改変は可能ですが、かならず出典を表記してください  
> 表記例: 野口　淳(2020) FOSS4G Japan 2020 Onlineチュートリアル「オンラインリソースによる考古遺跡地図作成」(https://github.com/kotdijian/JASOSR/tree/master/FOSS4Gtutorial)  
- 実習で使用するサンプルデータのオリジナルは[こちら](https://github.com/kotdijian/JASOSR/tree/master/13Tokyo)にあります。詳細はREADME.mdを参照してください  
> 表記例: JASOSR東京都遺跡データ(https://github.com/kotdijian/JASOSR/tree/master/13Tokyo)  

  
